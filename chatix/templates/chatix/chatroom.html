{% extends 'chatix/base.html' %}
{% load tz %}

{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<style>
    /* =========================================
       THEME-AWARE CHAT STYLES
       ========================================= */

    /* --- LIGHT MODE (DEFAULT) --- */
    .chat-layout {
        height: 85vh;
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        margin-top: 1rem;
        position: relative;
        border: 4px solid #e0e0e0;
        /* Light border */
    }

    .chat-header {
        padding: 15px 20px;
        background: #f8f9fa;
        /* Light Header */
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #333;
    }

    .chat-header .text-muted {
        color: #666 !important;
    }

    .chat-header .btn-light {
        background: #fff;
        border: 1px solid #ddd;
    }

    .chat-box {
        flex: 1;
        overflow-y: scroll;
        padding: 20px;
        background-color: #e5ddd5;
        /* WhatsApp-like Light BG */
        background-image:
            radial-gradient(#ccc 1px, transparent 1px),
            radial-gradient(#ccc 1px, transparent 1px);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        scroll-behavior: smooth;
    }

    /* INPUT AREA */
    .chat-footer {
        padding: 20px;
        background: #f8f9fa;
        /* Light Footer */
        border-top: 2px solid #e0e0e0;
    }

    /* Distinct Input Color for Light Mode */
    .chat-input {
        border-radius: 30px;
        padding: 15px 25px;
        border: 2px solid #ddd;
        /* Gradient for Light Mode Input as requested to be distinct */
        background: linear-gradient(to right, #ffffff, #f0f2f5);
        color: #333;
        transition: all 0.2s;
        font-size: 1rem;
    }

    .chat-input:focus {
        border-color: #f1c40f;
        box-shadow: 0 0 0 4px rgba(241, 196, 15, 0.1);
    }

    /* --- DARK MODE OVERRIDES --- */
    body.dark-mode .chat-layout {
        border-color: #4a4a4a;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .chat-header {
        background: #2c2c2c;
        border-bottom: 4px solid #4a4a4a;
        color: white;
    }

    body.dark-mode .chat-header .text-muted {
        color: #bbb !important;
    }

    body.dark-mode .chat-header .btn-light {
        background: #444;
        border-color: #555;
        color: white;
    }

    body.dark-mode .chat-box {
        background-color: #1a1a1a;
        background-image:
            radial-gradient(#333 1px, transparent 1px),
            radial-gradient(#333 1px, transparent 1px);
    }

    body.dark-mode .chat-footer {
        background: #2c2c2c;
        border-top: 4px solid #4a4a4a;
    }

    /* Distinct Input Color for Dark Mode - GRADIENT */
    body.dark-mode .chat-input {
        /* Deep Blue/Purple Gradient to stand out from dark background */
        background: linear-gradient(135deg, #2b1055, #7597de);
        border-color: #764ba2;
        color: white;
    }

    body.dark-mode .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    body.dark-mode .chat-input:focus {
        border-color: #fff;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
    }

    /* --- SHARED STYLES --- */
    .chat-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        background: linear-gradient(135deg, #f1c40f, #e67e22);
        font-size: 1.2rem;
        border: 2px solid #fff;
    }

    /* BUBBLES */
    .chat-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        font-size: 1rem;
        position: relative;
        word-wrap: break-word;
        line-height: 1.5;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* ME (SENT) */
    .chat-bubble.me {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-bottom-right-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-right: 45px;
    }

    /* OTHER (RECEIVED) */
    .chat-bubble.other {
        align-self: flex-start;
        background: #ffffff;
        /* White bubble in light mode */
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 4px;
        margin-left: 45px;
    }

    body.dark-mode .chat-bubble.other {
        background: #3a3a3a;
        color: #fff;
        border-color: #555;
    }

    /* AVATAR IN MSG */
    .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        position: absolute;
        bottom: 0px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        border: 2px solid #fff;
    }

    body.dark-mode .msg-avatar {
        border-color: #2c2c2c;
    }

    .msg-avatar.left {
        left: -45px;
    }

    .msg-avatar.right {
        right: -45px;
    }

    .chat-time {
        font-size: 0.7rem;
        margin-top: 5px;
        text-align: right;
        opacity: 0.7;
        font-weight: 500;
    }

    /* SCROLLBAR */
    .chat-box::-webkit-scrollbar {
        width: 8px;
    }

    .chat-box::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-box::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    body.dark-mode .chat-box::-webkit-scrollbar-thumb {
        background: #555;
    }

    /* UTILS & THEME OPTIONS */
    .delete-btn {
        visibility: hidden;
        opacity: 0;
        transition: all 0.2s;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        color: white;
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    body.dark-mode .delete-btn {
        background: rgba(255, 255, 255, 0.2);
    }

    .chat-bubble:hover .delete-btn {
        visibility: visible;
        opacity: 1;
    }

    .delete-btn:hover {
        background: #e74c3c !important;
    }

    .theme-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #ddd;
        transition: transform 0.2s;
    }

    .theme-option:hover {
        transform: scale(1.1);
        border-color: #333;
    }
</style>

<div class="container" style="max-width: 900px;">

    <div class="chat-layout">

        <!-- HEADER -->
        <div class="chat-header">
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'index' %}" class="btn btn-sm btn-icon btn-light rounded-circle shadow-sm"
                    style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    ‚Üê
                </a>

                {% for p in room.participants.all %}
                {% if p != request.user %}
                <div class="position-relative chat-avatar shadow-sm"
                    style="overflow: hidden; background: linear-gradient(135deg, #f1c40f, #e67e22);">
                    <!-- 1. Initials (Always rendered as background) -->
                    <div class="d-flex align-items-center justify-content-center w-100 h-100 text-white fw-bold"
                        style="font-size: 1.2rem;">
                        {{ p.username|slice:":1"|upper }}
                    </div>

                    <!-- 2. Image (Overlay, hides on error) -->
                    {% if p.userinfo.image %}
                    <img src="{{ p.userinfo.image.url }}" class="position-absolute top-0 start-0 w-100 h-100"
                        style="object-fit: cover;" onerror="this.style.display='none'">
                    {% endif %}
                </div>

                <div>
                    <h6 class="fw-bold mb-0 text-accent">{{ p.username }}</h6>
                    <small class="text-muted" style="font-size: 0.8rem;">
                        {% if p.last_login %}
                        üïê Last seen at {{ p.last_login|date:"h:i A" }}
                        {% else %}
                        <span class="text-success">‚óè Online</span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
                {% endfor %}
                {% if not room.participants.all %}
                <div class="chat-avatar shadow-sm">
                    {{ room.name|slice:":1"|upper }}
                </div>
                <div>
                    <h6 class="fw-bold mb-0 text-accent">{{ room.name }}</h6>
                </div>
                {% endif %}
            </div>

            <!-- THEME BUTTON -->
            <button class="btn btn-sm btn-light rounded-circle shadow-sm" style="width: 32px; height: 32px;"
                title="Change Wallpaper" onclick="toggleThemeMenu()">
                üé®
            </button>
        </div>

        <!-- THEME MENU (Hidden by default) -->
        <div id="theme-menu" class="p-3 bg-white shadow rounded position-absolute"
            style="display: none; top: 70px; right: 20px; z-index: 100; width: 220px;">
            <h6 class="fw-bold mb-2 small text-dark">Choose Background</h6>
            <div class="d-flex flex-wrap gap-2">
                <div class="theme-option shadow-sm" style="background: var(--bg);" onclick="setTheme('')"
                    title="Default"></div>
                <!-- Solid / Gradient Colors -->
                <div class="theme-option shadow-sm" style="background: #ece5dd;" onclick="setTheme('#ece5dd')"
                    title="WhatsApp Default"></div>
                <div class="theme-option shadow-sm" style="background: #202c33;" onclick="setTheme('#202c33')"
                    title="Dark Gray"></div>
                <div class="theme-option shadow-sm"
                    style="background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);"
                    onclick="setTheme('linear-gradient(135deg, #0f2027, #203a43, #2c5364)')" title="Deep Sea"></div>
                <div class="theme-option shadow-sm" style="background: linear-gradient(135deg, #373B44, #4286f4);"
                    onclick="setTheme('linear-gradient(135deg, #373B44, #4286f4)')" title="Blue Tech"></div>
                <div class="theme-option shadow-sm" style="background: linear-gradient(135deg, #8E2DE2, #4A00E0);"
                    onclick="setTheme('linear-gradient(135deg, #8E2DE2, #4A00E0)')" title="Royal Purple"></div>
                <div class="theme-option shadow-sm"
                    style="background: url('https://www.transparenttextures.com/patterns/cubes.png');"
                    onclick="setTheme('url(https://www.transparenttextures.com/patterns/cubes.png)')" title="Pattern">
                </div>
            </div>
        </div>

        <!-- MESSAGES -->
        <div id="messages" class="chat-box">
            {% for message in messages %}
            <div id="message-{{ message.id }}"
                class="chat-bubble {% if message.sender == request.user %}me{% else %}other{% endif %}">

                <!-- Stacked Avatar for Message -->
                <div class="msg-avatar {% if message.sender == request.user %}right{% else %}left{% endif %} position-absolute rounded-circle shadow-sm overflow-hidden"
                    style="background: #ccc;">

                    <!-- 1. Initials Background -->
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center fw-bold text-white small"
                        style="font-size: 10px; background: {% if message.sender == request.user %}#667eea{% else %}#ccc{% endif %};">
                        {{ message.sender.username|slice:":1"|upper }}
                    </div>

                    <!-- 2. Image Overlay -->
                    {% if message.sender.userinfo.image %}
                    <img src="{{ message.sender.userinfo.image.url }}"
                        class="position-absolute top-0 start-0 w-100 h-100" style="object-fit: cover;"
                        onerror="this.style.display='none'">
                    {% endif %}
                </div>

                {% if message.sender != request.user %}
                <div class="fw-bold mb-1" style="font-size: 0.75rem; color: var(--accent);">
                    {{ message.sender.username }}
                </div>
                {% endif %}

                {{ message.content }}

                <div class="chat-time">
                    {{ message.created_at|localtime|date:"h:i A" }}
                </div>

                {% if message.sender == request.user %}
                <button class="delete-btn shadow-sm" onclick="deleteMessage({{ message.id }})">‚úï</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- FOOTER -->
        <form class="chat-footer d-flex gap-2 align-items-center" id="chat-form">
            {% csrf_token %}
            <input type="text" id="message_input" class="form-control chat-input" placeholder="Type a message..."
                required autocomplete="off">
            <button class="btn btn-warning rounded-circle shadow-sm d-flex align-items-center justify-content-center"
                type="submit" style="width: 50px; height: 50px; flex-shrink: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </form>

    </div>
</div>

<script>
    const roomId = "{{ room.id }}";
    const username = "{{ request.user.username }}";

    const messageDiv = document.getElementById("messages");
    const input = document.getElementById("message_input");
    const form = document.getElementById("chat-form");

    // Auto-scroll to bottom on load
    messageDiv.scrollTop = messageDiv.scrollHeight;

    // Apply saved theme
    const savedTheme = localStorage.getItem(`chat_theme_${roomId}`);
    if (savedTheme) {
        messageDiv.style.background = savedTheme;
    }

    function toggleThemeMenu() {
        const menu = document.getElementById("theme-menu");
        menu.style.display = menu.style.display === "none" ? "block" : "none";
    }

    function setTheme(bg) {
        messageDiv.style.background = bg;
        localStorage.setItem(`chat_theme_${roomId}`, bg);
        document.getElementById("theme-menu").style.display = "none";
    }

    // Close menu when clicking outside
    document.addEventListener('click', function (event) {
        const menu = document.getElementById("theme-menu");
        const button = document.querySelector('button[title="Change Wallpaper"]');
        if (!menu.contains(event.target) && !button.contains(event.target)) {
            menu.style.display = 'none';
        }
    });

    // Use wss:// for HTTPS, ws:// for HTTP
    const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const socket = new WebSocket(
        wsProtocol + window.location.host + "/ws/chat/" + roomId + "/"
    );

    socket.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === "message_deleted") {
            document.getElementById(`message-${data.message_id}`)?.remove();
            return;
        }

        const bubble = document.createElement("div");
        bubble.id = `message-${data.message_id}`;
        bubble.className = "chat-bubble " + (data.sender === username ? "me" : "other");

        let deleteBtn = "";
        let senderName = "";

        // Avatar Logic
        const avatarClass = data.sender === username ? "right" : "left";
        let avatarHtml = "";
        if (data.avatar_url) {
            avatarHtml = `<img src="${data.avatar_url}" class="msg-avatar ${avatarClass}">`;
        } else {
            avatarHtml = `<div class="msg-avatar ${avatarClass} d-flex align-items-center justify-content-center fw-bold text-white small" style="background: #ccc; font-size: 10px;">${data.sender.charAt(0).toUpperCase()}</div>`;
        } // End Avatar Logic

        if (data.sender === username) {
            deleteBtn = `<button class="delete-btn shadow-sm" onclick="deleteMessage(${data.message_id})">‚úï</button>`;
        } else {
            senderName = `<div class="fw-bold mb-1" style="font-size: 0.75rem; color: var(--accent);">${data.sender}</div>`;
        }

        bubble.innerHTML = `
        ${avatarHtml}
        ${senderName}
        ${data.message}
        <div class="chat-time">${data.time || "Just now"}</div>
        ${deleteBtn}
    `;

        messageDiv.appendChild(bubble);
        messageDiv.scrollTop = messageDiv.scrollHeight;
    };

    form.onsubmit = e => {
        e.preventDefault();
        if (!input.value.trim()) return;

        socket.send(JSON.stringify({
            message: input.value,
            room_id: roomId
        }));
        input.value = "";
    };

    function deleteMessage(msgId) {
        Swal.fire({
            title: "Delete Message?",
            text: "This will remove the message for everyone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                fetch(`/delete-message/${msgId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "Content-Type": "application/json"
                    }
                }).then(res => {
                    if (res.ok) {
                        console.log("Message deleted successfully");
                    } else {
                        console.error("Failed to delete message");
                    }
                });
            }
        });
    }
</script>
{% endblock %}