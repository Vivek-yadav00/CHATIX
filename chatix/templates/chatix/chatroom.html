{% extends 'chatix/base.html' %}
{% load tz %}

{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<style>
    .chat-container {
        max-width: 700px;
        margin: auto;
    }

    .chat-box {
        height: 320px;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .chat-bubble {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 14px;
        font-size: 14px;
        position: relative;
        word-wrap: break-word;
    }

    /* SENT */
    .chat-bubble.me {
        align-self: flex-end;
        background: linear-gradient(135deg, #00c853, #64dd17);
        color: #000;
        border-bottom-right-radius: 4px;
    }

    /* RECEIVED â€“ LIGHT MODE */
    .chat-bubble.other {
        align-self: flex-start;
        background: linear-gradient(135deg, #7b2cff, #9b5cff);
        color: #ffffff;
        border-bottom-left-radius: 4px;
    }

    /* RECEIVED â€“ DARK MODE */
    body.dark-mode .chat-bubble.other {
        background: linear-gradient(135deg, #5e35b1, #7e57c2);
        color: #ffffff;
    }

    .chat-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
        text-align: right;
    }

    .chat-delete {
        position: absolute;
        top: 6px;
        right: 6px;
        background: none;
        border: none;
        cursor: pointer;
    }
</style>

<div class="chat-container mt-5">

    <h2 class="text-center mb-3" style="color:#f1c40f;">
        Chat Room: {{ room.name }}
    </h2>

    <p class="text-muted text-center mb-3">
        Created on: {{ room.created_at|localtime|date:"M d, Y h:i A" }}<br>
        Participants:
        {% for p in room.participants.all %}
        {{ p.username }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </p>

    <div id="messages" class="chat-box">
        {% for message in messages %}
        <div id="message-{{ message.id }}"
            class="chat-bubble {% if message.sender == request.user %}me{% else %}other{% endif %}">
            {{ message.content }}
            <div class="chat-time">
                {{ message.created_at|localtime|date:"h:i A" }}
            </div>

            {% if message.sender == request.user %}
            <button class="chat-delete" onclick="deleteMessage({{ message.id }})">ðŸ—‘</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <form class="input-group mt-3" id="chat-form">
        {% csrf_token %}
        <input type="text" id="message_input" class="form-control" placeholder="Type a message..." required>
        <button class="btn btn-warning fw-semibold" type="submit">Send</button>
    </form>

    <a href="{% url 'index' %}" class="btn btn-link mt-3">Back to Chat Rooms</a>
</div>

<script>
    const roomId = "{{ room.id }}";
    const username = "{{ request.user.username }}";

    const messageDiv = document.getElementById("messages");
    const input = document.getElementById("message_input");
    const form = document.getElementById("chat-form");

    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/" + roomId + "/"
    );

    socket.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === "message_deleted") {
            document.getElementById(`message-${data.message_id}`)?.remove();
            return;
        }

        const bubble = document.createElement("div");
        bubble.id = `message-${data.message_id}`;
        bubble.className = "chat-bubble " + (data.sender === username ? "me" : "other");

        let deleteBtn = "";
        if (data.sender === username) {
            deleteBtn = `<button class="chat-delete" onclick="deleteMessage(${data.message_id})">ðŸ—‘</button>`;
        }

        bubble.innerHTML = `
        ${data.message}
        <div class="chat-time">${data.time || "Just now"}</div>
        ${deleteBtn}
    `;

        messageDiv.appendChild(bubble);
        messageDiv.scrollTop = messageDiv.scrollHeight;
    };

    form.onsubmit = e => {
        e.preventDefault();
        if (!input.value.trim()) return;

        socket.send(JSON.stringify({
            message: input.value,
            sender: username,
            room_id: roomId
        }));
        input.value = "";
    };

    function deleteMessage(msgId) {
        Swal.fire({
            title: "Delete Message?",
            text: "This will remove the message for everyone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/delete-message/${msgId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                }).then(res => {
                    if (res.ok) {
                        // Message will be removed via WebSocket
                    } else {
                        Swal.fire("Error", "Failed to delete message", "error");
                    }
                });
            }
        });
    }
</script>
{% endblock %}