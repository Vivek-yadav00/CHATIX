{% extends 'chatix/base.html' %}

{% block title %}Chats{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 950px;">

    <!-- HEADER -->
    <div class="row align-items-center mb-5">
        <div class="col-md-8">
            <h2 class="fw-bold mb-1">
                Hello, <span class="text-accent">{{ request.user.username }}</span>
            </h2>
            <p class="text-muted">
                Welcome back to your messages.
            </p>
        </div>
        <div class="col-md-4 text-md-end d-flex gap-2 justify-content-md-end">
            <a href="{% url 'favorites' %}" class="btn btn-outline-warning fw-bold px-3 rounded-pill">
                ‚≠ê Favorites
            </a>
            <a href="{% url 'search' %}" class="btn btn-warning fw-bold px-4 rounded-pill shadow-sm">
                + New Chat
            </a>
        </div>
    </div>

    <!-- CHAT LIST -->
    {% if chatrooms %}
    <div class="row g-3">
        {% for room in chatrooms %}
        <div class="col-md-6 col-lg-4">
            <div class="card border-0 shadow-sm h-100 rounded-4 card-hover overflow-hidden transition-all">
                <div class="card-body p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-start">

                        <!-- LEFT: Avatar + Info -->
                        <div class="d-flex align-items-center gap-3">
                            {% with other_user=room.participants.all|first %}
                            {% for p in room.participants.all %}
                            {% if p != request.user %}
                            <div class="position-relative rounded-circle shadow-sm overflow-hidden"
                                style="width: 52px; height: 52px; background: linear-gradient(135deg, #667eea, #764ba2);">
                                <div class="d-flex align-items-center justify-content-center w-100 h-100 fw-bold text-white shadow-sm"
                                    style="font-size: 1.3rem;">
                                    {{ p.username|slice:":1"|upper }}
                                </div>
                                {% if p.userinfo.image %}
                                <img src="{{ p.userinfo.image.url }}"
                                    class="position-absolute top-0 start-0 w-100 h-100" style="object-fit: cover;"
                                    onerror="this.style.display='none'">
                                {% endif %}
                            </div>

                            <div>
                                <h6 class="fw-bold mb-0 text-truncate" style="max-width: 150px;">{{ p.username }}</h6>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    {% if p.userinfo.name %}
                                    {{ p.userinfo.name }}
                                    {% else %}
                                    <span class="text-success">‚óè Online</span>
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endwith %}

                            {% if not room.participants.all %}
                            <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center fw-bold text-white shadow-sm"
                                style="width: 52px; height: 52px; background: linear-gradient(135deg, #f1c40f, #e67e22); font-size: 1.3rem;">
                                {{ room.name|slice:":1"|upper }}
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0">{{ room.name }}</h6>
                            </div>
                            {% endif %}
                        </div>

                        <!-- RIGHT: Actions + Latest Message -->
                        <div class="d-flex flex-column align-items-end" style="z-index: 2;">
                            <!-- Actions Row -->
                            <div class="d-flex gap-2 mb-2">
                                <button
                                    class="btn btn-sm btn-icon toggle-fav {% if request.user in room.favorited_by.all %}text-warning{% else %}text-muted{% endif %}"
                                    data-id="{{ room.id }}" title="Toggle Favorite">
                                    {% if request.user in room.favorited_by.all %}‚òÖ{% else %}‚òÜ{% endif %}
                                </button>
                                <button class="btn btn-sm btn-icon text-muted delete-room delete-hover"
                                    data-id="{{ room.id }}" title="Remove chat">
                                    ‚úï
                                </button>
                            </div>

                            <!-- Latest Message Row -->
                            {% with last_msg=room.messages.last %}
                            {% if last_msg %}
                            <div class="text-end latest-msg-container" style="max-width: 150px;">
                                <small class="fw-bold d-block text-dark opacity-75 mb-1" style="font-size: 0.7rem;">
                                    {{ last_msg.created_at|date:"h:i A" }}
                                </small>
                                <small class="text-muted d-block text-truncate fst-italic">
                                    {% if last_msg.sender == request.user %}You: {% endif %}{{ last_msg.content }}
                                </small>
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                    </div>

                    <a href="{% url 'chatroom' room.id %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- EMPTY STATE -->
    <div class="text-center py-5">
        <div class="mb-4">
            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
                style="width: 80px; height: 80px;">
                <span style="font-size: 2rem;">üí¨</span>
            </div>
        </div>
        <h4 class="fw-bold mb-2">No messages yet</h4>
        <p class="text-muted mb-4">Start a conversation to connect with others.</p>
        <a href="{% url 'search' %}" class="btn btn-warning px-4 py-2 fw-bold rounded-pill shadow-sm">
            Start a Chat
        </a>
    </div>
    {% endif %}

    <style>
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow) !important;
        }

        .transition-all {
            transition: all 0.3s ease;
        }

        .delete-hover:hover {
            color: #dc3545 !important;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 50%;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none !important;
        }

        /* Make sure delete button is above the stretched link */
        .delete-room,
        .toggle-fav {
            position: relative;
            z-index: 2;
        }

        .toggle-fav:hover {
            color: #f1c40f !important;
        }

        .toggle-fav {
            font-size: 1.2rem;
        }
    </style>

    <!-- ================= DELETE CHAT (FOR ME ONLY) ================= -->
    <script>
        document.querySelectorAll(".delete-room").forEach(btn => {
            btn.onclick = function () {
                const roomId = this.dataset.id;

                Swal.fire({
                    title: "Delete chat?",
                    text: "This chat will be removed only for you.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#6c757d",
                    confirmButtonText: "Delete",
                    cancelButtonText: "Cancel"
                }).then(result => {
                    if (result.isConfirmed) {
                        fetch(`/room/delete/${roomId}/`, {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}"
                            }
                        }).then(() => {
                            // üî• Remove card instantly
                            btn.closest(".col-md-6").remove();
                        });
                    }
                });
            };
        });

        // ‚≠ê Toggle Favorite
        document.querySelectorAll(".toggle-fav").forEach(btn => {
            btn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const roomId = this.dataset.id;
                const starBtn = this;

                fetch(`/room/toggle-favorite/${roomId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                }).then(res => res.json()).then(data => {
                    if (data.is_favorite) {
                        starBtn.classList.remove("text-muted");
                        starBtn.classList.add("text-warning");
                        starBtn.innerHTML = "‚òÖ";
                    } else {
                        starBtn.classList.remove("text-warning");
                        starBtn.classList.add("text-muted");
                        starBtn.innerHTML = "‚òÜ";
                    }
                });
            };
        });

        // üî• Real-time Dashboard Updates - Use wss:// for HTTPS
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const notifySocket = new WebSocket(
            wsProtocol + window.location.host + "/ws/notify/"
        );

        notifySocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.type === "notification") {
                const chatList = document.querySelector(".row.g-3") || document.querySelector(".row.g-4");
                const cardCol = document.querySelector(`.delete-room[data-id="${data.room_id}"]`)?.closest(".col-md-6");

                const timeNow = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const msgContent = (data.sender === "{{ request.user.username }}" ? "You: " : "") + data.message;

                if (cardCol) {
                    // 1. Update Latest Message
                    const msgContainer = cardCol.querySelector(".latest-msg-container");
                    if (msgContainer) {
                        msgContainer.querySelector("small.text-dark").innerText = timeNow;
                        msgContainer.querySelector("small.text-muted").innerText = msgContent;
                    } else {
                        // Insert if missing (active chat but no prev msg)
                        const actionsDiv = cardCol.querySelector(".d-flex.flex-column.align-items-end");
                        actionsDiv.insertAdjacentHTML("beforeend", `
                            <div class="text-end latest-msg-container" style="max-width: 150px;">
                                <small class="fw-bold d-block text-dark opacity-75 mb-1" style="font-size: 0.7rem;">${timeNow}</small>
                                <small class="text-muted d-block text-truncate fst-italic">${msgContent}</small>
                            </div>
                        `);
                    }

                    // 2. Move to Top with Animation
                    if (chatList.firstElementChild !== cardCol) {
                        cardCol.style.transition = "transform 0.3s";
                        chatList.prepend(cardCol);
                    }
                } else {
                    // Create New Card (Simplified for now, ideal would be to clone logic)
                    location.reload();
                }
            }
        };
    </script>
    {% endblock %}